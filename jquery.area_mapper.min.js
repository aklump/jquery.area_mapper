/**
 * Area Mapper jQuery JavaScript Plugin v0.0.1
 * 
 *
 * jQuery plugin providing a CRUD UI for defining areas over an image.
 *
 * Copyright 2013, Aaron Klump
 * Dual licensed under the MIT or GPL Version 2 licenses.
 *
 * Date: Wed Jul  2 15:19:14 PDT 2014
 */(function(e,t,n,r){"use strict";function i(t,n){this.element=t;this.element=t;this.$container=null;this.areas=[];this.selector=null;this.state={op:"create",selected:null,selectorOp:"hidden"};this.render={remove:[],removeFlag:[]};this.options=e.extend({},e.fn.areaMapper.defaults,n);this.init()}i.prototype={onSelectStart:function(e,t){var n=this;n.state.selectorOp==="hidden"&&(n.state.selectorOp="selecting");n.deselectArea().refreshMap();n.callbackInvoke("onSelectStart",{});return this},onSelectEnd:function(e,t){var n=this;n.state.selectorOp==="selecting"&&(n.state.selectorOp="selected");n.showControls().refreshMap();var r={};typeof t!="undefined"&&(r={x:t.x1,y:t.y1,w:t.width,h:t.height});n.callbackInvoke("onSelectEnd",r);return this},selectorCancel:function(){var e=this;e.selector.cancelSelection();e.state.selectorOp="hidden";e.removeFlagFromAll("resizing").deselectArea().hideControls().refreshMap();e.callbackInvoke("onSelectCancel",{});return this},saveAreaFromSelection:function(e){var t=this,n=t.readArea(e),r="onUpdate";if(n===!1){t.createArea(e,{});n={};r="onCreate"}var i=t.selector.getSelection();n.x=i.x1;n.y=i.y1;n.w=i.width;n.h=i.height;t.state.selectorOp="hidden";t.updateArea(e,n).refreshMap();t.selector.cancelSelection();var s=t.readArea(e);t.callbackInvoke(r,s);return this},getNextId:function(){var e=this,t=0;for(var n in e.areas)parseInt(n,10)>0&&(t=Math.max(t,n));t+=1;return t},activateSelectionFromArea:function(t){var n=this,r=n.readArea(t);if(r===!1)return!1;n.selector.setSelection(r.x,r.y,r.x+r.w,r.y+r.h);n.addFlag(t,"resizing");n.selector.update();var i=n.selector.getOptions();i.show=!0;n.selector.setOptions(i);e(n.options.controls.updateTrigger).show();e(n.options.controls.updateCancel).show();n.refreshMap();return!0},createArea:function(e,t){this.areas[e]={};return this.updateArea(e,t)},readArea:function(e){return typeof this.areas[e]=="undefined"?!1:this.areas[e]},updateArea:function(t,n){var r=this.readArea(t);if(r){typeof n=="string"&&(n=e.parseJSON(n));this.areas[t]=e.extend({x:null,y:null,w:null,h:null,flags:{}},r,n,{id:t})}return this},deleteArea:function(t){var n=this,r=n.readArea(t);if(r){n.areas[t]=null;n.render.remove.push(e("#"+n.options.cssPrefix+r.id));n.hideControls().callbackInvoke("delete",r)}return this},unsetArea:function(t){var n=this;n.areas[t]=null;n.render.remove.push(e("#"+n.options.cssPrefix+t));return this},selectArea:function(e){var t=this,n=t.readArea(e);if(n&&n.id!==t.state.selected){var r="selected";t.removeFlagFromAll(r);t.addFlag(e,r);t.state.selected=e;t.state.op="update";t.showControls();t.callbackInvoke("select",n)}return this},deselectArea:function(e){var t=this;typeof e=="undefined"&&(e=t.state.selected);var n=t.readArea(e);t.removeFlag(e,"selected");t.state.selected=null;t.state.op="create";t.callbackInvoke("deselect",n);return this},addFlag:function(e,t){this.readArea(e)&&(this.areas[e].flags[t]=t);return this},removeFlag:function(e,t){if(this.readArea(e)){delete this.areas[e].flags[t];this.render.removeFlag.push([e,t])}return this},removeFlagFromAll:function(e){for(var t in this.areas)this.removeFlag(t,e);return this},refreshBodyClasses:function(){var t=this,n=this.options.cssPrefix;e("body").removeClass(n+"selector-hidden").removeClass(n+"selector-selecting").removeClass(n+"selector-selected").removeClass(n+"selector-resizing").addClass(n+"selector-"+t.state.selectorOp);e("body").removeClass(n+"op-create").removeClass(n+"op-update").removeClass(n+"op-delete").addClass(n+"op-"+t.state.op)},refreshMap:function(){var t=this;t.refreshBodyClasses();for(var n in t.render.remove){e(t.render.remove[n]).remove();delete t.render.remove[n]}for(var r in t.areas){var i=t.readArea(r);i&&t.renderArea(i)}return this},showControls:function(){var t=this;switch(t.state.op){case"create":e(t.options.controls.updateTrigger+","+t.options.controls.updateCancel+","+t.options.controls.deleteTrigger+","+t.options.controls.deleteCancel).hide();e(t.options.controls.createTrigger+","+t.options.controls.createCancel).show();break;case"update":e(t.options.controls.createTrigger+","+t.options.controls.createCancel).hide();e(t.options.controls.updateTrigger+","+t.options.controls.updateCancel+","+t.options.controls.deleteTrigger+","+t.options.controls.deleteCancel).show();break;case"delete":e(t.options.controls.deleteTrigger+","+t.options.controls.deleteCancel).show()}return this},hideControls:function(){var t=this;e(t.options.controls.createTrigger+","+t.options.controls.createCancel+","+t.options.controls.updateTrigger+","+t.options.controls.updateCancel+","+t.options.controls.deleteTrigger+","+t.options.controls.deleteCancel).hide();return this},renderArea:function(t){var n=this,r=this.options.cssPrefix,i=r+t.id,s=e("#"+i);if(s.length===0){s=e('<div id="'+i+'"/>').addClass(r+"area").click(function(){if(t.id===n.state.selected)n.deselectArea(t.id);else{n.state.selectorOp="resizing";n.selectArea(t.id).activateSelectionFromArea(t.id)}n.refreshMap()});e(this.element).after(s)}s.css({position:"absolute",left:t.x,top:t.y,width:t.w,height:t.h});for(var o in this.render.removeFlag){var u=this.render.removeFlag[o][0],a=this.render.removeFlag[o][1];e("#"+r+u).removeClass(r+a);delete this.render.removeFlag[o]}for(var a in t.flags)s.addClass(r+a);return this},callbackInvoke:function(e,t){if(typeof this.options.callbacks!="undefined"&&typeof this.options.callbacks[e]=="function"){var n=t?JSON.stringify(t):"";return this.options.callbacks[e](e,n,t)}return!0},init:function(){var t=this,n=this.options.cssPrefix;e("#convert").hide();e("body").addClass(t.options.cssPrefix+"processed");t.$container=e(t.element).addClass(t.options.cssPrefix+"processed").wrap('<div class="'+t.options.cssPrefix+'container"/>').parent("."+t.options.cssPrefix+"container");var r=t.options.imgAreaSelect||{};r.instance=!0;r.onSelectStart=function(e,n){t.onSelectStart(e,n)};r.onSelectEnd=function(e,n){t.onSelectEnd(e,n);n.width===0&&n.height===0&&t.selectorCancel()};t.selector=e(t.element).imgAreaSelect(r);e(t.options.controls.createTrigger).not("."+n+"processed").addClass(n+"processed").click(function(){t.saveAreaFromSelection(t.getNextId()).hideControls().refreshMap();return!1});e(t.options.controls.updateTrigger).not("."+n+"processed").addClass(n+"processed").click(function(){t.removeFlagFromAll("resizing").saveAreaFromSelection(t.state.selected).deselectArea().hideControls().refreshMap();t.refreshMap();return!1});e(t.options.controls.deleteTrigger).not("."+n+"processed").addClass(n+"processed").click(function(){t.state.op="delete";t.refreshBodyClasses();if(t.options.confirm("Are you sure you want to delete this area?")){t.state.op="create";t.deleteArea(t.state.selected).selectorCancel().refreshMap()}return!1});e(t.options.controls.createCancel).not("."+n+"processed").addClass(n+"processed").click(function(){t.selectorCancel();return!1});e(t.options.controls.updateCancel).not("."+n+"processed").addClass(n+"processed").click(function(){t.selectorCancel();return!1});e(t.options.controls.deleteCancel).not("."+n+"processed").addClass(n+"processed").click(function(){t.selectorCancel();return!1});t.refreshMap().callbackInvoke("init")}};e.fn.areaMapper=function(t){e.data(this[0],"plugin_areaMapper")||e.data(this[0],"plugin_areaMapper",new i(this[0],t));return e.data(this[0],"plugin_areaMapper")};e.fn.areaMapper.defaults={confirm:function(e){return confirm(e)},callbacks:{init:null,onCreate:null,onUpdate:null,select:null,"delete":null,onSelectStart:null,onSelectEnd:null,onSelectCancel:null},controls:{createTrigger:"#am-create",createCancel:"#am-cancel",updateTrigger:"#am-update",updateCancel:"#am-cancel",deleteTrigger:"#am-delete",deleteCancel:"#am-cancel"},imgAreaSelect:{handles:!1},cssPrefix:"am-"};e.fn.areaMapper.version=function(){return"0.0.1"}})(jQuery,window,document);