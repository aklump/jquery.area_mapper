/**
 * Area Mapper jQuery JavaScript Plugin v0.0.1
 * 
 *
 * jQuery plugin providing a CRUD UI for defining areas over an image.
 *
 * Copyright 2013, Aaron Klump
 * Dual licensed under the MIT or GPL Version 2 licenses.
 *
 * Date: Fri May  9 17:10:42 PDT 2014
 */(function(e,t,n,r){"use strict";function i(t,n){this.element=t;this.options=e.extend({},e.fn.areaMapper.defaults,n);this.init()}i.prototype={areas:[],timers:{},selector:null,state:{selected:null},render:{remove:[],removeFlag:[]},onSelectEnd:function(t,n){var r=this;e("#convert").show().click(function(){r.createAreaFromSelection()})},createAreaFromSelection:function(t){var n=this,r=n.selector.getSelection(),i={x:r.x1,y:r.y1,w:r.width,h:r.height};n.createArea(t,i).addFlag(t,"changed").addFlag(t,"selected").refreshMap();n.selector.cancelSelection();e("#convert").hide()},createArea:function(e,t){this.areas[e]={};return this.updateArea(e,t)},readArea:function(e){return typeof this.areas[e]===r?!1:this.areas[e]},updateArea:function(t,n){var r=this.readArea(t);if(r){typeof n=="string"&&(n=e.parseJSON(n));this.areas[t]=e.extend({x:null,y:null,w:null,h:null,flags:{}},r,n,{id:t})}return this},deleteArea:function(t){var n=this.readArea(t);if(n){this.areas[t]=null;this.render.remove.push(e("#"+this.options.cssPrefix+n.id));this.callbackInvoke("delete",n)}return this},selectArea:function(e){var t=this.readArea(e);if(t&&t.id!==this.state.selected){var n="selected";this.removeFlagFromAll(n);this.addFlag(e,n);this.state.selected=e;this.callbackInvoke("select",t)}return this},deselectArea:function(e){var t=this.readArea(e);if(t&&t.id===this.state.selected){this.removeFlag(e,"selected");this.state.selected=null;this.callbackInvoke("deselect",t)}return this},addFlag:function(e,t){this.readArea(e)&&(this.areas[e].flags[t]=t);return this},removeFlag:function(e,t){if(this.readArea(e)){delete this.areas[e].flags[t];this.render.removeFlag.push([e,t])}return this},removeFlagFromAll:function(e){for(var t in this.areas)this.removeFlag(t,e);return this},refreshMap:function(){for(var t in this.render.remove){e(this.render.remove[t]).remove();delete this.render.remove[t]}for(var n in this.areas){var r=this.readArea(n);r&&this.renderArea(r)}return this},renderArea:function(t){var n=this,r=this.options.cssPrefix+t.id,i=e("#"+r);if(i.length===0){var s=e('<a href="#" title="Click to delete this area" class="'+this.options.cssPrefix+'delete"></a>').click(function(){n.options.confirm("Are you sure you want to delete this area?")&&n.deleteArea(t.id).refreshMap()});i=e('<div id="'+r+'"/>').addClass(this.options.cssPrefix+"area").html(s).click(function(){t.id===n.state.selected?n.deselectArea(t.id):n.selectArea(t.id);n.refreshMap()});e(this.element).after(i)}i.css({position:"absolute",left:t.x,top:t.y,width:t.w,height:t.h});for(var o in this.render.removeFlag){var u=this.render.removeFlag[o][0],a=this.render.removeFlag[o][1];e("#"+this.options.cssPrefix+u).removeClass(this.options.cssPrefix+a);delete this.render.removeFlag[o]}for(var a in t.flags)i.addClass(this.options.cssPrefix+a);return this},callbackInvoke:function(e,t){if(typeof this.options.callbacks!="undefined"&&typeof this.options.callbacks[e]=="function"){var n=t?JSON.stringify(t):"";return this.options.callbacks[e](e,n,t)}return!0},init:function(){var t=this;e("#convert").hide();e(t.element).addClass(t.options.cssPrefix+"processed").wrap('<div class="'+t.options.cssPrefix+'container"/>');var n=t.options.imgAreaSelect||{};n.instance=!0;n.onSelectEnd=function(e,n){t.onSelectEnd(e,n)};t.selector=e(t.element).imgAreaSelect(n);t.callbackInvoke("init")}};e.fn.areaMapper=function(t){e.data(this[0],"plugin_areaMapper")||e.data(this[0],"plugin_areaMapper",new i(this[0],t));return e.data(this[0],"plugin_areaMapper")};e.fn.areaMapper.defaults={confirm:function(e){return confirm(e)},callbacks:{init:null,select:null,"delete":null},imgAreaSelect:{handles:!1},cssPrefix:"area-mapper-"};e.fn.areaMapper.version=function(){return"0.0.1"}})(jQuery,window,document);